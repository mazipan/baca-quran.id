name: Deploy to GitHub Pages

on:
  workflow_dispatch:
  push:
    branches:
      - 'master'
      - 'main'

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: 'pages'
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Only run if this is the specific repository
    if: github.repository == 'mazipan-quran-offline/baca-quran.id'

    env:
      CI: true
      TURBO_TELEMETRY_DISABLED: 1
      DO_NOT_TRACK: 1
      HUSKY: 0

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0
          token: ${{ secrets.PERSONAL_TOKEN }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        env:
          PUBLIC_FIREBASE_API_KEY: ${{ secrets.PUBLIC_FIREBASE_API_KEY }}
          PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.PUBLIC_FIREBASE_AUTH_DOMAIN }}
          PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.PUBLIC_FIREBASE_PROJECT_ID }}
          PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.PUBLIC_FIREBASE_STORAGE_BUCKET }}
          PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          PUBLIC_FIREBASE_APP_ID: ${{ secrets.PUBLIC_FIREBASE_APP_ID }}
          PUBLIC_FIREBASE_MEASUREMENT_ID: ${{ secrets.PUBLIC_FIREBASE_MEASUREMENT_ID }}
        run: |
          pnpm run build
          touch build/.nojekyll

      - name: Fix permissions
        # Only run this on forked repo in mazipan-quran-offline
        if: github.repository == 'mazipan-quran-offline/baca-quran.id'
        run: |
          chmod -c -R +rX "build/" | while read line; do
            echo "::warning title=Invalid file permissions automatically fixed::$line"
          done

      - name: Commit generated files only
        # Only run this on forked repo in mazipan-quran-offline
        if: github.repository == 'mazipan-quran-offline/baca-quran.id'
        run: |
          echo "> Start remove unused files..."
          rm -rf .github/workflows .svelte-kit markdowns screenshoot scripts static src node_modules .husky .vscode
          rm -rf .all-contributorsrc .editorconfig .eslintignore eslint.config.js .gitignore .kodiak.toml .npmrc .prettierignore .prettierrc package.json pnpm-lock.yaml package-lock.json pnpm-workspace.yaml postcss.config.js svelte.config.js tailwind.config.js tsconfig.json vite.config.ts .env.example .nvmrc .lighthouserc.json
          echo "> Copy build directory..."
          cp -r build/. ./
          rm -rf build
          echo "> Set git config..."
          git config --local user.email "mazipanneh@gmail.com"
          git config --local user.name "Irfan Maulana"

          echo "> Add and commit files..."
          git add -A
          git commit -m "[CI]: Auto Deploy ðŸš€"
          echo "> Finish commit changes to repo"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          repository: mazipan-quran-offline/mazipan-quran-offline.github.io
          force: true
          github_token: ${{ secrets.PERSONAL_TOKEN }}
          branch: master
